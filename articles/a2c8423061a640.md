---
title: "Zenn問答第15回「VPN」"
emoji: "🔐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["vpn", "ipsec", "security", "network"]
published: true
---

# Zenn問答とは

「Zenn問答」とは、開発していて「なんとなく使ってるけど、ちゃんと理解してるかな？」という技術について、改めて時間をとって深掘りしてみようという企画です🧘🧘🧘

# はじめに

社内ネットワークに接続する際、多くの方がVPNを使っていると思います。リモートワークの普及により、VPN接続はより日常的なものとなりました。

「通信が盗聴されないように暗号化されている」ということは理解していて、いくつかの種類があることは理解していましたが、改めてその詳細な仕組みまで理解しているかと言われると自信がありませんでした。

ということで今回は、VPNについて改めて時間をとって深掘りしてみます。

# VPNの誕生の経緯

VPN（Virtual Private Network）は、1990年代中頃にインターネットの商用利用が本格化する中で誕生しました。

## なぜVPNが必要だったのか

それ以前、企業が複数拠点間でセキュアな通信を行うには、専用線を利用するのが一般的でした。しかし、専用線には大きな問題がありました。

**専用線の課題**
- 月額コストが非常に高額（拠点間の距離に応じて数十万〜数百万円）
- 拠点追加のたびに新たな回線契約が必要
- 導入までに数週間〜数ヶ月の期間が必要
- 物理的な回線のため柔軟性に欠ける

## インターネットVPNという発想

「すでに普及しているインターネット回線上に、暗号化技術を使って仮想的な専用線を作れないか」という発想から、VPNが生まれました。

1996年、MicrosoftがPPTP（Point-to-Point Tunneling Protocol）を開発し、Windows NTに実装しました。これが最初の広く普及したVPNプロトコルとなりました。

その後、セキュリティの強化と標準化のため、IETFがIPSecを策定し、VPNは企業インフラとして定着していきました。

## リモートワークの普及とVPN

2020年代のリモートワーク普及により、VPNの用途は拠点間接続から、個人ユーザーの企業ネットワークへのリモートアクセスへと大きく広がりました。

この変化に伴い、より軽量で高速なプロトコル（WireGuard、IKEv2など）が注目されるようになりました。

# VPNの基本的な仕組み

VPNは主に2つの技術を組み合わせて実現されています。

## 1. トンネリング

トンネリングとは、あるネットワークプロトコルのパケットを別のプロトコルでカプセル化する技術です。

```mermaid
graph LR
    A[元のIPパケット] --> B[VPNヘッダーを追加]
    B --> C[新しいIPパケット]
    C --> D[インターネット経由で送信]

    style A fill:#f9f,stroke:#333
    style C fill:#9f9,stroke:#333
```

元のパケットが「荷物」、VPNヘッダーが「外箱」のようなイメージです。外からは中身の荷物（元のパケット）が見えません。

## 2. 暗号化

トンネリングだけでは、パケットの中身を覗かれる可能性があります。そこで、カプセル化されたデータを暗号化します。

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant VPN_C as VPNクライアント
    participant Internet as インターネット
    participant VPN_S as VPNサーバー
    participant Server as 社内サーバー

    Client->>VPN_C: データ送信
    VPN_C->>VPN_C: データを暗号化
    VPN_C->>VPN_C: VPNヘッダーでカプセル化
    VPN_C->>Internet: 暗号化されたパケット送信
    Internet->>VPN_S: 暗号化されたパケット到着
    VPN_S->>VPN_S: カプセル化を解除
    VPN_S->>VPN_S: データを復号化
    VPN_S->>Server: 元のデータ送信
```

この2つの技術により、インターネット上でも安全な通信が実現できます。

## VPNの2つの主な利用形態

VPNには大きく分けて2つの利用形態があります。

### サイト間VPN（Site-to-Site VPN）

企業の拠点間を接続するVPNです。各拠点のルーターやファイアウォールにVPN機能を設定し、拠点間をセキュアに接続します。

```mermaid
graph LR
    A[本社ネットワーク] --> B[VPNルーター]
    B --> C[インターネット]
    C --> D[VPNルーター]
    D --> E[支社ネットワーク]

    style C fill:#ff9,stroke:#333
```

### リモートアクセスVPN

個人のPCやスマートフォンから企業ネットワークに接続するVPNです。リモートワークで使用するのは主にこちらのタイプです。

```mermaid
graph LR
    A[個人PC/スマホ] --> B[VPNクライアント]
    B --> C[インターネット]
    C --> D[VPNゲートウェイ]
    D --> E[企業ネットワーク]

    style C fill:#ff9,stroke:#333
```

# 主要なVPNプロトコルの種類と特徴

VPNにはさまざまなプロトコルが存在します。それぞれの誕生時期と特徴を見ていきましょう。

## プロトコルの歴史

| プロトコル | 登場年 | 開発元 | 主な特徴 |
|------------|--------|--------|----------|
| PPTP | 1996 | Microsoft | 初期の広く普及したVPNプロトコル。現在は非推奨 |
| L2TP/IPSec | 1999 | IETF | PPTPの後継。IPSecと組み合わせて使用 |
| IPSec | 1995年代 | IETF | 業界標準のセキュアな通信プロトコル |
| OpenVPN | 2001 | James Yonan | オープンソース、高い互換性とセキュリティ |
| IKEv2/IPSec | 2005 | Microsoft & Cisco | モバイル環境に最適。ネットワーク切替に強い |
| WireGuard | 2016 | Jason A. Donenfeld | 最新プロトコル。シンプルで高速 |

こう見ると本当に結構最近開発されたプロトコルもあって面白いですね。

# 各プロトコルの詳細

今でもよく使われるプロトコルについて少し詳細に取り上げます。

## IPSec（Internet Protocol Security）

**主な特徴**
- IETF標準でほぼすべてのVPN対応機器に実装されており、異なるベンダー間でも互換性が高い
- ネットワーク層で動作するため、拠点全体のトラフィックを透過的に暗号化
- IPパケット全体を暗号化（トンネルモード）し、強力なセキュリティを実現

**利用シーン**
- 企業拠点間を接続するサイト間VPN
- 異なるベンダーの機器を組み合わせる環境
- 長期的に安定した接続が必要な拠点間通信

**接続の仕組み**

2段階で接続を確立します（合計4〜6往復）。

1. **フェーズ1** - 鍵交換用の安全な通信路を作る（2〜3往復）
2. **フェーズ2** - データ転送用の暗号化設定を決める（2〜3往復）
3. **データ転送** - 確立した設定で通信開始

## OpenVPN

**主な特徴**
- HTTPSと同じSSL/TLSを使用するため、信頼性が高く広く普及
- ポート443を使えるため、ファイアウォールを通過しやすい
- オープンソースでクロスプラットフォーム対応

**利用シーン**
- 企業のリモートアクセスVPN
- ファイアウォールが厳しい環境でのリモートワーク
- プライバシー重視のVPNサービス

**接続の仕組み**

HTTPSと同じ流れで接続します（合計2〜3往復）。

1. **TLSハンドシェイク** - 証明書でサーバーを検証（1〜2往復）
2. **ユーザー認証** - ユーザー名とパスワードで認証（1往復）
3. **データ転送** - 暗号化通信を開始

## IKEv2/IPSec

**主な特徴**
- Wi-Fiから4G/5Gへの切替時もVPN接続が切断されない（MOBIKE機能）
- わずか2往復で接続確立でき、従来のIPSecより高速
- Windows、macOS、iOS、Androidで標準サポート

**利用シーン**
- スマートフォンやタブレットからのVPN接続
- 移動中やネットワークが頻繁に切り替わる環境
- Azure VPN Gatewayなどのクラウドサービス

**接続の仕組み**

IPSecを改良し、高速に接続します。

1. **初期化** - 暗号化方式の合意と鍵交換を同時実行（1往復）
2. **認証** - 認証とデータ転送設定を同時実行（1往復）
3. **データ転送** - 暗号化通信を開始
4. **MOBIKE** - ネットワーク切替時も接続を自動維持

## WireGuard

**主な特徴**
- わずか約4,000行のコード（OpenVPNの約1/37）でシンプル
- OpenVPNの約3倍以上の速度とデータ効率、バッテリー効率に優れる
- 最新の暗号化技術を使用し、設定がシンプル

**利用シーン**
- 高速な通信が必要な環境
- モバイルデバイスからのリモートアクセス
- IoTなどリソースが限られたデバイス

**接続の仕組み**

SSH鍵認証と似た考え方で、非常にシンプルです。

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant Server as サーバー

    Note over Client,Server: 事前準備：鍵ペアを生成して公開鍵を交換
    Note over Client: クライアントの秘密鍵を保存<br/>サーバーの公開鍵を保存
    Note over Server: サーバーの秘密鍵を保存<br/>クライアントの公開鍵を保存

    Note over Client,Server: 接続確立（わずか1往復）
    Client->>Server: 初期化メッセージ（暗号化済み）
    Server->>Client: 応答メッセージ（暗号化済み）
    Note over Client,Server: 接続完了

    Note over Client,Server: データ転送
    Client->>Server: 暗号化データ
    Server->>Client: 暗号化データ

    Note over Client,Server: ネットワーク切替
    Client->>Client: WiFi → 4G/5Gに切替
    Client->>Server: 新IPアドレスからパケット送信
    Note over Server: 公開鍵で認証、送信元更新
    Note over Client,Server: 接続継続（特別な通知不要）
```

公開鍵の交換はモバイルアプリのQRコードなどの手段で行うのが一般的みたいです。

# 他の暗号化通信手段との違い

VPN以外にも、通信を暗号化する手段はいくつか存在します。それぞれの違いを見ていきましょう。

## SSH Tunnel

SSH（Secure Shell）のポートフォワーディング機能を使って、暗号化されたトンネルを作る手法です。

**仕組み**
```mermaid
graph LR
    A[アプリケーション] --> B[SOCKSプロキシ]
    B --> C[SSHトンネル]
    C --> D[インターネット]
    D --> E[SSHサーバー]
    E --> F[目的のサーバー]

    style C fill:#9f9,stroke:#333
```

**VPNとの違い**

| 項目 | VPN | SSH Tunnel |
|------|-----|------------|
| **動作レベル** | OS全体（ネットワーク層） | アプリケーションごと |
| **設定の範囲** | 全通信を自動でルーティング | アプリごとにプロキシ設定が必要 |
| **セットアップ** | VPNサーバーの構築が必要 | SSHサーバーがあればOK |
| **用途** | 企業ネットワークへの接続 | 特定アプリの通信を暗号化 |
| **透過性** | 完全に透過的 | アプリがプロキシ対応している必要あり |

SSH Tunnelは「貧者のVPN（Poor man's VPN）」と呼ばれることがあります。VPNほど包括的ではありませんが、手軽に特定の通信を暗号化できます。

## stunnel

stunnelは、SSL/TLSトンネルを提供するユーティリティです。

**仕組み**
```mermaid
sequenceDiagram
    participant App as アプリケーション
    participant Stunnel_C as stunnel（クライアント側）
    participant Internet as インターネット
    participant Stunnel_S as stunnel（サーバー側）
    participant Service as サービス

    App->>Stunnel_C: 平文データ送信（ローカル接続）
    Stunnel_C->>Stunnel_C: SSL/TLSで暗号化
    Stunnel_C->>Internet: 暗号化されたデータ送信
    Internet->>Stunnel_S: 暗号化されたデータ到着
    Stunnel_S->>Stunnel_S: SSL/TLSで復号化
    Stunnel_S->>Service: 平文データ送信（ローカル接続）
```

**特徴**
- SSL/TLS暗号化に対応していないサービスを暗号化できる
- 両端（クライアントとサーバー）にstunnelの設定が必要
- 特定のポート・サービスに特化

## 比較まとめ

| 技術 | 動作レベル | 透過性 | 設定の複雑さ | 主な用途 |
|------|-----------|--------|------------|---------|
| **VPN** | OS全体 | 完全に透過的 | 中〜高 | 企業ネットワーク接続、全通信の保護 |
| **SSH Tunnel** | アプリケーション単位 | アプリがプロキシ対応している必要あり | 低 | 特定アプリの通信保護、開発環境 |
| **stunnel** | アプリケーション単位 | サービスレベルで透過的 | 中 | レガシーサービスのSSL化 |
| **HTTPS** | アプリケーション層 | Webブラウザで透過的 | 低（サーバー側のみ） | Webトラフィックの保護 |

# おまけ：なぜVPNを繋ぐと社内システムにアクセスできるのか

「VPNを繋いでいないと社内システムにアクセスできない」という当たり前のことですが、その仕組みを改めて図解してみます。

## VPN接続なしの場合

```mermaid
sequenceDiagram
    participant PC as 自宅PC<br/>(123.45.67.89)
    participant Internet as インターネット
    participant FW as 企業ファイアウォール
    participant DNS as 社内DNS<br/>(10.0.0.1)
    participant App as 社内システム<br/>(10.0.50.100)

    Note over PC: internal-app.company.localに<br/>アクセスしたい

    PC->>PC: DNSで名前解決を試みる<br/>(公開DNS: 8.8.8.8を使用)
    Note over PC: ❌ ドメインが見つからない<br/>(社内ドメインは公開されていない)

    Note over PC: 仮にIPアドレス(10.0.50.100)を<br/>知っていたとしても...

    PC->>Internet: パケット送信<br/>(宛先: 10.0.50.100)
    Note over Internet: ❌ プライベートIPアドレスは<br/>インターネット上でルーティングされない

    Note over FW: 外部からの直接アクセスは<br/>ファイアウォールでブロック
```

**なぜアクセスできないのか**

1. **DNS解決の問題**: 社内ドメイン（例: `internal-app.company.local`）は社内DNSサーバーにしか登録されていないため、外部の公開DNSでは名前解決できない
2. **プライベートIPアドレス**: 社内システムはプライベートIPアドレス（10.0.0.0/8など）を使用しており、インターネット上ではルーティングできない
3. **ファイアウォール**: 仮にIPアドレスを知っていても、企業のファイアウォールが外部からの直接アクセスをブロックしている

## VPN接続ありの場合

```mermaid
sequenceDiagram
    participant PC as 自宅PC<br/>(123.45.67.89)
    participant VPN_Client as VPNクライアント
    participant Internet as インターネット
    participant VPN_GW as VPNゲートウェイ<br/>(企業ネットワーク内)
    participant DNS as 社内DNS<br/>(10.0.0.1)
    participant App as 社内システム<br/>(10.0.50.100)

    Note over PC,VPN_GW: VPN接続を確立
    VPN_Client->>VPN_GW: VPN接続要求
    VPN_GW->>VPN_Client: ✅ 仮想IPアドレスを付与<br/>(10.0.0.100)
    Note over PC: PCは企業ネットワーク内にいる<br/>かのように振る舞える

    Note over PC: internal-app.company.localに<br/>アクセスしたい

    PC->>VPN_Client: DNS問い合わせ<br/>(internal-app.company.local)
    Note over VPN_Client: VPN設定で社内DNSを使用

    VPN_Client->>Internet: 暗号化されたパケット送信
    Internet->>VPN_GW: 暗号化パケット到着
    VPN_GW->>DNS: DNS問い合わせ<br/>(復号化済み)
    DNS->>VPN_GW: ✅ IPアドレス: 10.0.50.100
    VPN_GW->>Internet: 暗号化して返信
    Internet->>VPN_Client: 暗号化パケット到着
    VPN_Client->>PC: ✅ IPアドレス: 10.0.50.100

    Note over PC: 名前解決成功！

    PC->>VPN_Client: HTTPリクエスト<br/>(宛先: 10.0.50.100)
    VPN_Client->>VPN_Client: パケットを暗号化・カプセル化
    VPN_Client->>Internet: 暗号化パケット送信<br/>(外側の宛先: VPNゲートウェイ)
    Internet->>VPN_GW: 暗号化パケット到着
    VPN_GW->>VPN_GW: 復号化・カプセル解除
    VPN_GW->>App: ✅ HTTPリクエスト<br/>(送信元: 10.0.0.100)
    Note over VPN_GW,App: 企業ネットワーク内の<br/>通常の通信として処理

    App->>VPN_GW: HTTPレスポンス
    VPN_GW->>Internet: 暗号化して返信
    Internet->>VPN_Client: 暗号化パケット到着
    VPN_Client->>PC: ✅ HTTPレスポンス
```

**なぜVPNを繋ぐとアクセスできるのか**

1. **仮想的に企業ネットワーク内に参加**: VPNゲートウェイがクライアントに企業ネットワーク内の仮想IPアドレスを付与し、あたかも社内にいるかのように扱われる
2. **社内DNSが使える**: VPN接続時にDNS設定が自動的に社内DNSサーバーに切り替わり、社内ドメインの名前解決ができる
3. **ファイアウォールの内側からのアクセス**: VPNゲートウェイが企業ネットワーク内に設置されているため、そこから社内システムへのアクセスは「内部からのアクセス」として扱われ、ファイアウォールを通過できる
4. **暗号化トンネル**: インターネット上では暗号化されたパケットとして送信されるため、盗聴されても中身は読めない

# まとめ

今回はVPNについて改めて深掘りしてみました。

単に「通信を暗号化して経路を確立するもの」という理解から、様々なプロトコルがあるものの、結局暗号化してヘッダーつけて通信をしていることを理解しました。

トンネリングとかいう言葉は前々から知っていたのですが、あんまり何をしているがイメージがついていませんでした。調べてみて、VPNサーバーって結構重要な役割をしているなと感じました。VPNサーバーが攻撃対象になったら大変だ・・・

最後まで読んでいただき、ありがとうございました🙏
