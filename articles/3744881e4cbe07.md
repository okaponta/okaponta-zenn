---
title: "Zennå•ç­”ç¬¬7å›ã€ŒuseStateã€"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React", "TypeScript", "frontend"]
published: false
---

# Zennå•ç­”ã¨ã¯

ã€ŒZennå•ç­”ã€ã¨ã¯ã€é–‹ç™ºã—ã¦ã„ã¦ã€Œãªã‚“ã¨ãªãä½¿ã£ã¦ã‚‹ã‘ã©ã€ã¡ã‚ƒã‚“ã¨ç†è§£ã—ã¦ã‚‹ã‹ãªï¼Ÿã€ã¨ã„ã†æŠ€è¡“ã«ã¤ã„ã¦ã€æ”¹ã‚ã¦æ™‚é–“ã‚’ã¨ã£ã¦æ·±æ˜ã‚Šã—ã¦ã¿ã‚ˆã†ã¨ã„ã†ä¼ç”»ã§ã™ğŸ§˜ğŸ§˜ğŸ§˜

# ã¯ã˜ã‚ã«

Reactã®é–‹ç™ºã«ãŠã„ã¦ã€`useState`ã¯æœ€ã‚‚é »ç¹ã«ä½¿ã†Hookã®ä¸€ã¤ã‹ã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã‚‚æœ€è¿‘å…¥é–€æ›¸ã‚’èª­ã‚“ã§å­¦ç¿’ã—ãªãŠã—ãŸã®ã§ã™ãŒåºç›¤ã‚‚åºç›¤ã«ç™»å ´ã—ã¾ã—ãŸã€‚ã¨ã‚Šã‚ãˆãšãªã‚“ã¨ãªãä½¿ã„æ–¹ã¯ç†è§£ã—ã¾ã—ãŸãŒã€ãã¡ã‚“ã¨ç†è§£ã§ãã¦ã„ãªã‹ã£ãŸã®ã§ä»Šå›æ·±æ˜ã‚Šã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# useStateã®æ¦‚è¦ã¨å¼•æ•°ã®å‹

`useState`ã®å‹å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```typescript
function useState<S>(initialState: S | (() => S)): [S, Dispatch<SetStateAction<S>>];
```

`S`å‹ã‹`(() => S)`å‹ã‚’å¼•æ•°ã«ã¨ã‚Šã€`S`å‹ã¨`Dispatch<SetStateAction<S>>`å‹ã®ã‚¿ãƒ—ãƒ«ã‚’è¿”å´ã—ã¾ã™ã€‚å¼•æ•°ã¯åˆæœŸå€¤ã§ã€æˆ»ã‚Šå€¤ã¯ç¾åœ¨ã®çŠ¶æ…‹ã¨ãã‚Œã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°ã§ã™ã€‚

```typescript
const [count, setCount] = useState(init);
```

ã¿ãŸã„ãªã®ã¯å…¥é–€æ›¸ã¨ã‹ã§ã‚ˆãè¦‹ã‚‹æ§‹æˆã‹ã¨æ€ã„ã¾ã™ã€‚è‡ªåˆ†ã‚‚ãŸãã•ã‚“å†™çµŒã—ã¾ã—ãŸã€‚

## å¼•æ•°ã®å‹ `S | (() => S)`

å¼•æ•°ã«ã¯`S`å‹ã‹`(() => S)`å‹ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚èª¿ã¹ã¦ã¿ãŸã‚‰ã€é–¢æ•°ã‚’æ¸¡ã™ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯å¤§ã¾ã‹ã«è¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„åˆæœŸåŒ–ãªã©ã‚’é¿ã‘ãŸã„å ´åˆã«ä½¿ã†ã¿ãŸã„ã§ã™ã€‚

```typescript
// âŒ æ‚ªã„ä¾‹ï¼šæ¯å›ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§é‡ã„å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹
const [data, setData] = useState(
  heavyProcess() // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ã‚‚æ¯å›å®Ÿè¡Œ
);

// âœ… è‰¯ã„ä¾‹ï¼šåˆå›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
const [expensiveData, setExpensiveData] = useState(() => {
  return heavyProcess(); // åˆå›ã®1å›ã ã‘å®Ÿè¡Œ
});
```

ãªãœä¸‹ã®å ´åˆã«ã¯åˆå›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
è©³ã—ãã¯ã“ã®è¨˜äº‹ã®å¾ŒåŠã§ã‚½ãƒ¼ã‚¹ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ãŸã®ã§ã™ãŒã€Reactã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«åˆæœŸæç”»ã¨2å›ç›®ä»¥é™ã§å‡¦ç†ãŒåˆ†å²ã—ã¾ã™ã€‚ç›´æ¥å€¤ã‚’æ¸¡ã™ã¨åˆæœŸæç”»ã¨2å›ç›®ä»¥é™æç”»ã®åˆ¤æ–­ã®å‰ã«é–¢æ•°ãŒè©•ä¾¡ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã«ã“ã®ã‚ˆã†ãªã“ã¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ã‚‚ã†å°‘ã—ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ´ã‚€ãŸã‚ã«å®Ÿéš›ã«ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚

```typescript
var isInitialized = false;

function hoge(init: void | (() => void)){
    if (!isInitialized) {
        console.log("Initialize")
        if (typeof init === 'function'){
            init()
        }
        isInitialized = true
        return
    }
    console.log("Already Initialized")
}

const fuga = () => {
    console.log("fuga")
}

hoge(fuga());
// [LOG]: "fuga" 
// [LOG]: "Initialize" 
hoge(fuga());
// [LOG]: "fuga" 
// [LOG]: "Already Initialized" 

isInitialized = false;

hoge(fuga)
// [LOG]: "Initialize" 
// [LOG]: "fuga" 

hoge(fuga)
// [LOG]: "Already Initialized"
```

ä»¥ä¸‹ã®`TS Playground`ã§ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚

https://www.typescriptlang.org/play/?ssl=17&ssc=2&pln=3&pc=1#code/G4QwTgBAlgzgkgOygFyiANlAXgUwCYQC8EAZhjDgNwBQ1JArggMaoD2CEAFqwOY4AUUJMgBcEYKygEAPhH78AlEQB84yXgUKA3tQh7oJOQEJYiFGky4NEHfrsQm7GK3Q4AdOl78ARGdQZsHG8FXXs9KEN+ZABPAAccVkMhFCJCYgByBmY2BHTtULC7ZORFAvsAXzKi+GELQIJiZDB6HCr9MBxkejAEMsq7RwRnVw8vbwBBdA6QPGiIPzqrYOpK6kGYZFJ6HhAiOSVCVVt9dZd3Tx4fBh3l1e4+fmuQRQUae4Enl5pqU1qAqz2ZHQFG+70e2xAITBTxCQA

ãªã‚‹ã»ã©ã€`S`å‹ã‹`(() => S)`å‹ã®é•ã„ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
ã“ã†ãªã‚‹ã¨ã€`() => S`å‹ã ã‘ã§ã‚‚ã„ã„ã‚ˆã†ãªæ°—ãŒã—ã¦ãã¾ã™ã€‚ã“ã‚Œã¯æ¨æ¸¬ã«ãªã‚Šã¾ã™ãŒã€åˆæœŸå€¤ãŒ0ã§æ±ºã¾ã£ã¦ã„ã‚‹ã‚ˆã†ãªè¨ˆç®—ã‚³ã‚¹ãƒˆãŒã»ã¼ç„¡ã„ã‚ˆã†ãªã‚‚ã®ã«ã¤ã„ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ã‚‹ã‚ˆã†ãªè¦ªåˆ‡å¿ƒã ã¨æ€ã„ã¾ã™ã€‚

```typescript
useState(0)
useState(() => 0)
```

ã“ã‚Œã‚’ã¿ãŸæ™‚ã«ä¸Šã§æ›¸ã„ãŸæ–¹ãŒç°¡å˜ã˜ã‚ƒã­ï¼Ÿã¨ã„ã†ãã‚‰ã„ã ã¨æ€ã„ã¾ã™ã€‚å€‹äººçš„ã«ã¯`() => S`å‹ã§çµ±ä¸€ã—ãŸæ–¹ãŒã‚ã‹ã‚Šã‚„ã™ã„æ°—ã‚‚ã—ã¾ã™ãŒãƒ»ãƒ»ãƒ»ã©ã†ãªã‚“ã§ã—ã‚‡ã†ã‹

# å†…éƒ¨å®Ÿè£…ã‚’ç°¡å˜ã«èª­ã‚“ã§ã¿ã‚‹

`v19.1.1`ã®ã‚¿ã‚°ã§èª­ã‚“ã§ã„ãã¾ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react/src/ReactHooks.js#L72

```typescript
export function useState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  const dispatcher = resolveDispatcher();
  return dispatcher.useState(initialState);
}
```

`dispatcher`ã¨ã‚„ã‚‰ã‚’å–å¾—ã—ã¦ã€ãã®ä¸­ã®`useState`ã«å¼•æ•°ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react/src/ReactHooks.js#L30

```typescript
function resolveDispatcher() {
  const dispatcher = ReactSharedInternals.H;
  // (ä¸­ç•¥)
  return ((dispatcher: any): Dispatcher);
}
```

`dispatcher`ã¯ä½•ã‹ã¨ã„ã†ã¨ã€`ReactSharedInternals.H`ã®ã“ã¨ã‚‰ã—ã„ã€‚
å®Ÿéš›ã«`ReactSharedInternals.H`ã«å€¤ã‚’ã„ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã‚’æ¢ã™ã¨ã€ä»¥ä¸‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L551

å¤§äº‹ãªã¨ã“ã‚ã ã‘æŠ½å‡ºã™ã‚‹ã¨ã€ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```js
    ReactSharedInternals.H =
      current === null || current.memoizedState === null
        ? HooksDispatcherOnMount
        : HooksDispatcherOnUpdate;
```

åˆå›æç”»æ™‚ã¯`HooksDispatcherOnMount`ã€äºŒå›ç›®ä»¥é™ã¯`HooksDispatcherOnUpdate`ãŒ`ReactSharedInternals.H`ã®å®Ÿæ…‹ã¿ãŸã„ã§ã™ã­ã€‚
ã“ã®ãµãŸã¤ã§ä½•ãŒé•ã†ã®ã‹ã¨ã„ã†ã®ãŒæ°—ã«ãªã‚Šã¾ã™ã­ã€‚`HooksDispatcherOnMount`ã¨`HooksDispatcherOnUpdate`ã‚’å®£è¨€ã—ã¦ã„ã‚‹`updateSwipeTransition`ã®é–¢æ•°ã®ä¸­ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`useState`ã«æ¸¡ã—ã¦ã„ã‚‹é–¢æ•°ãŒå‰è€…ã¯`mountState`ã€äºŒå›ç›®ä»¥é™ã¯`updateState`ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®2ã¤ã®é–¢æ•°ã‚’èª­ã‚ã°åˆå›å®Ÿè¡Œæ™‚ã¨äºŒå›ç›®ä»¥é™å®Ÿè¡Œæ™‚ã®æŒ™å‹•ã®é•ã„ãŒåˆ†ã‹ã‚Šãã†ã§ã™ã€‚

## åˆå›æç”»æ™‚ã®mountState

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L1940

```typescript
function mountState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  const hook = mountStateImpl(initialState);
  const queue = hook.queue;
  const dispatch: Dispatch<BasicStateAction<S>> = (dispatchSetState.bind(
    null,
    currentlyRenderingFiber,
    queue,
  ): any);
  queue.dispatch = dispatch;
  return [hook.memoizedState, dispatch];
}
```

`mountStateImpl`ã«`initialState`ã‚’æ¸¡ã—ã¦åˆæœŸåŒ–å‡¦ç†ã‚’è¡Œã£ã¦ã€ãã®å¾Œãªã‚“ã‚„ã‹ã‚“ã‚„ã—ã¦ã‹ã‚‰Stateã®å€¤ã¨Stateæ›´æ–°ç”¨ã®é–¢æ•°ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

çµå±€`hook`ã®ä¸­èº«ã‚’è¦‹ãªã„ã¨ãªã‚“ã¨ã‚‚ã„ãˆãªã„ã®ã§ã€ä¸­èº«ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L1912

```typescript
function mountStateImpl<S>(initialState: (() => S) | S): Hook {
  const hook = mountWorkInProgressHook();
  if (typeof initialState === 'function') {
    const initialStateInitializer = initialState;
    // $FlowFixMe[incompatible-use]: Flow doesn't like mixed types
    initialState = initialStateInitializer();
    if (shouldDoubleInvokeUserFnsInHooksDEV) {
      setIsStrictModeForDevtools(true);
      try {
        // $FlowFixMe[incompatible-use]: Flow doesn't like mixed types
        initialStateInitializer();
      } finally {
        setIsStrictModeForDevtools(false);
      }
    }
  }
  hook.memoizedState = hook.baseState = initialState;
  const queue: UpdateQueue<S, BasicStateAction<S>> = {
    pending: null,
    lanes: NoLanes,
    dispatch: null,
    lastRenderedReducer: basicStateReducer,
    lastRenderedState: (initialState: any),
  };
  hook.queue = queue;
  return hook;
}
```

`if (typeof initialState === 'function')`ã®ãƒ–ãƒ­ãƒƒã‚¯ã«ã¤ã„ã¦ã¯å¼•æ•°ã®`initialState`ãŒé–¢æ•°å‹ãªã‚‰å®Ÿè¡Œã—ã¦ã„ã‚‹ã ã‘ã§ã™ã­ã€‚
ãã®å¾Œ`hook`ã®`memoizedState`ã¨`baseState`ã«åˆæœŸå€¤ã‚’ä»£å…¥ã—ã¦ã„ã¾ã™ã€‚
ãã®å¾Œ`UpdateQueue`ã‚’æ–°è¦ã§ä½œæˆã—ã€`hook`ã®`queue`ã«ä»£å…¥ã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€å‘¼ã³å‡ºã—å…ƒã§`dispatch`ã‚’æ–°ãŸã«å®£è¨€ã—ã¦`queue`ã®`dispatch`ã«ä»£å…¥ã€è¿”å´ã—ã¦ã„ã¾ã™ã€‚

### hookã®queueã¨dispatchã¨ã¯

`hook.queue`ã¯**çŠ¶æ…‹æ›´æ–°ã‚’ç®¡ç†ã™ã‚‹ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ **ã®ã‚ˆã†ã§ã™ã€‚è¤‡æ•°ã®çŠ¶æ…‹æ›´æ–°ãŒåŒæ™‚ã«ç™ºç”Ÿã—ãŸå ´åˆã‚„ã€éåŒæœŸæ›´æ–°ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
`state`ã®æ›´æ–°ãŒ3ã¤ãŒã‚ã‚‹ãŒã€æç”»ãŒ1å›ã§ã‚ˆã„å ´åˆãªã©ã€ã‚­ãƒ¥ãƒ¼ã«ãŸã‚ãŸæ›´æ–°ã‚’ä¸€æ°—ã«å‡¦ç†ã™ã‚‹ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§æ‰ãˆã¦ã„ã¾ã™ã€‚

å‹ã¨ãã®æ¦‚è¦ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```typescript
// UpdateQueue ã®æ§‹é€ 
export type UpdateQueue<S, A> = {
  pending: Update<S, A> | null,        // å¾…æ©Ÿä¸­ã®æ›´æ–°ãƒªã‚¹ãƒˆï¼ˆå¾ªç’°ãƒªãƒ³ã‚¯ãƒªã‚¹ãƒˆï¼‰
  lanes: Lanes,                        // å„ªå…ˆåº¦ãƒ¬ãƒ¼ãƒ³ï¼ˆç·Šæ€¥åº¦ã‚’è¡¨ã™ï¼‰
  dispatch: (A => mixed) | null,       // setStateé–¢æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‘¼ã³å‡ºã™é–¢æ•°ï¼‰
  lastRenderedReducer: ((S, A) => S) | null,  // æœ€å¾Œã«ä½¿ç”¨ã•ã‚ŒãŸãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼é–¢æ•°
  lastRenderedState: S | null,         // æœ€å¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸçŠ¶æ…‹å€¤
};

// Update ã®æ§‹é€ 
export type Update<S, A> = {
  lane: Lane,                          // ã“ã®æ›´æ–°ã®å„ªå…ˆåº¦ãƒ¬ãƒ¼ãƒ³
  revertLane: Lane,                    // ãƒªãƒãƒ¼ãƒˆæ™‚ã®å„ªå…ˆåº¦ãƒ¬ãƒ¼ãƒ³
  action: A,                           // å®Ÿè¡Œã™ã‚‹æ›´æ–°å†…å®¹ï¼ˆå€¤ or é–¢æ•°ï¼‰
  hasEagerState: boolean,              // äº‹å‰è¨ˆç®—ã•ã‚ŒãŸçŠ¶æ…‹ãŒã‚ã‚‹ã‹ã©ã†ã‹
  eagerState: S | null,                // äº‹å‰è¨ˆç®—ã•ã‚ŒãŸæ¬¡ã®çŠ¶æ…‹å€¤
  next: Update<S, A>,                  // æ¬¡ã®æ›´æ–°ã¸ã®å‚ç…§ï¼ˆå¾ªç’°ãƒªã‚¹ãƒˆï¼‰
};
```

ã‚‚ã†å°‘ã—æ·±è¿½ã„ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€`setState`ã®æ¦‚è¦ç†è§£ã‹ã‚‰é›¢ã‚Œã¦ã„ã‚‹æ°—ã‚‚ã™ã‚‹ã®ã§ãªã‚“ã¨ãªãã“ã®ã‚ˆã†ãªã‚‚ã®ã¨ã„ã†ã¨ã“ã‚ã§ä»Šå›ã¯æ­¢ã‚ã¦ãŠãã¾ã™ã€‚ç¶šã„ã¦`queue`ã®`dispatch`ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚
ã‚‚ã†ä¸€åº¦æŒ¯ã‚Šè¿”ã‚‹ã¨ã€`dispatch`ã¯`setCount`ã‚„`setName`ãªã©ã®åå‰ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã€**çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®é–¢æ•°**ã¨ã—ã¦è¿”å´ã•ã‚Œã‚‹ã‚‚ã®ã§ã—ãŸã€‚

å°‘ã—å‰ã«è¦‹ãŸ`mountState`é–¢æ•°ã‚’ã¿ã‚‹ã¨ã€dispatché–¢æ•°ã®å®Ÿä½“ã¯`dispatchSetState`ã®ã‚ˆã†ã§ã™ã€‚æ—©é€Ÿã¿ã¦ã„ãã¾ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L3735

```typescript
function dispatchSetState<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
): void {
  if (__DEV__) {
    // (ä¸­ç•¥)
  }
  const lane = requestUpdateLane(fiber);
  const didScheduleUpdate = dispatchSetStateInternal(
    fiber,
    queue,
    action,
    lane,
  );
  if (didScheduleUpdate) {
    startUpdateTimerByLane(lane);
  }
  markUpdateInDevTools(fiber, lane, action);
}
```

æœ¬ä½“ã¯`dispatchSetStateInternal`ã¿ãŸã„ã§ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L3765

```typescript
function dispatchSetStateInternal<S, A>(
  fiber: Fiber,
  queue: UpdateQueue<S, A>,
  action: A,
  lane: Lane,
): boolean {
  const update: Update<S, A> = {
    lane,
    revertLane: NoLane,
    action,  // æ›´æ–°å†…å®¹ï¼ˆ5 ã‚„ (c) => c + 1ï¼‰
    hasEagerState: false,
    eagerState: null,
    next: (null: any),
  };

  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­ã¯ã©ã†ã‚„ã‚‰é•ã†å‡¦ç†ã‚‰ã—ã„
  if (isRenderPhaseUpdate(fiber)) {
    enqueueRenderPhaseUpdate(queue, update);
  } else {
    const alternate = fiber.alternate;
    if (
      fiber.lanes === NoLanes &&
      (alternate === null || alternate.lanes === NoLanes)
    ) {
      // ã‚­ãƒ¥ãƒ¼ãŒç©ºã®å ´åˆã«ã¯ã„ã¡ã„ã¡ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã›ãšã«äº‹å‰ã«è¨ˆç®—ã™ã‚‹
      const lastRenderedReducer = queue.lastRenderedReducer;
      if (lastRenderedReducer !== null) {
        let prevDispatcher = null;
        if (__DEV__) {
          prevDispatcher = ReactSharedInternals.H;
          ReactSharedInternals.H = InvalidNestedHooksDispatcherOnUpdateInDEV;
        }
        try {
          const currentState: S = (queue.lastRenderedState: any);
          const eagerState = lastRenderedReducer(currentState, action);

          update.hasEagerState = true;
          update.eagerState = eagerState;
          if (is(eagerState, currentState)) {
            // çŠ¶æ…‹ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
            enqueueConcurrentHookUpdateAndEagerlyBailout(fiber, queue, update);
            return false;
          }
        } catch (error) {
          // Suppress the error. It will throw again in the render phase.
        } finally {
          if (__DEV__) {
            ReactSharedInternals.H = prevDispatcher;
          }
        }
      }
    }

    // æ›´æ–°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã™ã‚‹
    const root = enqueueConcurrentHookUpdate(fiber, queue, update, lane);
    if (root !== null) {
      // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¦æ±‚
      scheduleUpdateOnFiber(root, fiber, lane);
      entangleTransitionUpdate(root, queue, lane);
      return true;
    }
  }
  return false;
}
```

ã¨ã„ã†ã‚ã‘ã§ã€ã–ã£ãã‚Šã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ãã†ã§ã™ã€‚

- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§`setCount(5)`ã¨ã‹ã‚’å‘¼ã³å‡ºã—
- `Update`å‹ã‚’ä½œæˆã—ã¦ã€ã‚­ãƒ¥ãƒ¼ã«è©°ã‚ã‚‹
- æ›´æ–°ã®ãƒãƒƒãƒå‡¦ç†ã‚’ã™ã‚‹
  - ã“ã“ã§æ›´æ–°ãŒãªã‘ã‚Œã°å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è¦æ±‚

ãªã‚“ã‚„ã‹ã‚“ã‚„æ›¸ãã¾ã—ãŸãŒã€`dispatch`ã‚’ä½¿ã†ã“ã¨ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã¸ã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è¦æ±‚ãŒç™ºç”Ÿã™ã‚‹ã®ã§`state`ã®å€¤ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«å†æç”»ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

## äºŒå›ç›®ä»¥é™æç”»æ™‚ã®updateState

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L1954

```typescript
function updateState<S>(
  initialState: (() => S) | S,
): [S, Dispatch<BasicStateAction<S>>] {
  return updateReducer(basicStateReducer, initialState);
}
```

å®Ÿéš›ã®å‡¦ç†ã¯`updateReducer`ã«å§”è­²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯`useState`ãŒå†…éƒ¨çš„ã«ã¯`useReducer`ã®ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L1342

```typescript
function updateReducer<S, I, A>(
  reducer: (S, A) => S,
  initialArg: I,
  init?: I => S,
): [S, Dispatch<A>] {
  const hook = updateWorkInProgressHook();
  return updateReducerImpl(hook, ((currentHook: any): Hook), reducer);
}
```

å®Ÿéš›ã®å‡¦ç†ã¯`updateReducerImpl`ã«æ›¸ã‹ã‚Œã¦ã„ãã†ã§ã™ãŒã€ã“ã“ã§åˆæœŸå€¤ãŒæ¸¡ã£ã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚äºŒå›ç›®ä»¥é™ã®å ´åˆã¯ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åˆæœŸå€¤ã‚„åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°ãŒæ¨ã¦ã‚‰ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

https://github.com/facebook/react/blob/v19.1.1/packages/react-reconciler/src/ReactFiberHooks.js#L1351

ã•ã¦ã€`updateReducerImpl`ã‚’èª­ã‚€ã‹ãƒ»ãƒ»ãƒ»ã¨ãªã‚Šã¾ã—ãŸãŒã€ãªã‚“ã¨250è¡Œãã‚‰ã„ã‚ã£ã¦å¿ƒãŒæŠ˜ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ã¾ã‚ã€å¤§ä½“åŒã˜ã ã¨æ€ã†ã®ã§AIãŒä½œã£ã¦ãã‚ŒãŸç°¡å˜ãªæ¯”è¼ƒè¡¨ã‚’ãŠã„ã¦ãŠã—ã¾ã„ã«ã—ã¾ã™ã€‚

### **mountState ã¨ updateState ã®é•ã„**

| é …ç›® | mountStateï¼ˆåˆå›ï¼‰ | updateStateï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼‰ |
|------|-------------------|----------------------------|
| **Hookä½œæˆ** | æ–°ã—ã„Hookã‚’ä½œæˆ | æ—¢å­˜Hookã‚’å†åˆ©ç”¨ |
| **åˆæœŸå€¤å‡¦ç†** | initialStateã‚’è©•ä¾¡ãƒ»è¨­å®š | initialStateã¯ç„¡è¦– |
| **ã‚­ãƒ¥ãƒ¼å‡¦ç†** | ç©ºã®ã‚­ãƒ¥ãƒ¼ã‚’ä½œæˆ | è“„ç©ã•ã‚ŒãŸæ›´æ–°ã‚’å‡¦ç† |
| **çŠ¶æ…‹è¨ˆç®—** | åˆæœŸå€¤ã‚’ãã®ã¾ã¾è¨­å®š | è¤‡æ•°æ›´æ–°ã‚’é †æ¬¡é©ç”¨ |
| **dispatchä½œæˆ** | æ–°ã—ã„dispatché–¢æ•°ã‚’ä½œæˆ | æ—¢å­˜dispatché–¢æ•°ã‚’å†åˆ©ç”¨ |

ã¨ã„ã†ã‚ã‘ã§`useState`ã‚’ä½¿ã†ã¨ãªã‚“ã§å†æç”»ã•ã‚Œã‚‹ã‹ãŒãªã‚“ã¨ãªãç†è§£ã§ãã¾ã—ãŸã€‚`useState`ã®æˆ»ã‚Šå€¤ã¯`hook`ã®`queue`ã®`dispatch`ã®`action`ã¨ã—ã¦ä¿å­˜ã•ã‚Œã€`dispatch`ã®ä¸­ã§ã„ã„æ„Ÿã˜ã«å†æç”»ãŒã‚­ãƒƒã‚¯ã•ã‚Œã‚‹ã‚ˆã†ã§ã—ãŸã€‚

# æ¦‚è¦å›³

## useStateå…¨ä½“ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Component as ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    participant Hook as Hook System
    participant Queue as Update Queue
    participant Scheduler as React Scheduler

    Note over Component: åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    Component->>Hook: useState(initialState)
    Hook->>Hook: mountStateå®Ÿè¡Œ
    Hook->>Queue: æ–°ã—ã„ã‚­ãƒ¥ãƒ¼ä½œæˆ
    Hook->>Component: [çŠ¶æ…‹, dispatch]ã‚’è¿”å´
    Component->>User: åˆæœŸUIã‚’è¡¨ç¤º

    Note over User,Scheduler: çŠ¶æ…‹æ›´æ–°ãƒ•ã‚§ãƒ¼ã‚º
    User->>Component: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    Component->>Hook: setCount(newValue)
    Hook->>Queue: Updateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    Hook->>Scheduler: å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è¦æ±‚
    
    Note over Component: å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    Scheduler->>Component: å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹
    Component->>Hook: useState(initialState)
    Note over Hook: initialStateã¯ç„¡è¦–
    Hook->>Hook: updateStateå®Ÿè¡Œ
    Hook->>Queue: è“„ç©ã•ã‚ŒãŸæ›´æ–°ã‚’å‡¦ç†
    Queue->>Hook: æ–°ã—ã„çŠ¶æ…‹ã‚’è¨ˆç®—
    Hook->>Component: [æ–°ã—ã„çŠ¶æ…‹, dispatch]ã‚’è¿”å´
    Component->>User: æ›´æ–°ã•ã‚ŒãŸUIã‚’è¡¨ç¤º
```

## çŠ¶æ…‹æ›´æ–°ï¼ˆdispatchå‘¼ã³å‡ºã—ï¼‰ã®æµã‚Œ

```mermaid
flowchart TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒsetCountå‘¼ã³å‡ºã—] --> B[dispatchSetStateå®Ÿè¡Œ]
    B --> C[Updateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ]
    C --> D{ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ï¼Ÿ}
    D -->|Yes| E[äº‹å‰è¨ˆç®—ã‚’è©¦è¡Œ]
    D -->|No| F[ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ]
    E --> G{çŠ¶æ…‹å¤‰æ›´ã‚ã‚Šï¼Ÿ}
    G -->|No| H[å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¹ã‚­ãƒƒãƒ—]
    G -->|Yes| F
    F --> I[æ›´æ–°ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ  å¾ªç’°ãƒªã‚¹ãƒˆ]
    I --> J[ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°è¦æ±‚]
    J --> K[æ¬¡ã®æ›´æ–°ã‚µã‚¤ã‚¯ãƒ«ã§å‡¦ç†]
    
    style A fill:#fff3e0
    style C fill:#f3e5f5
    style H fill:#ffebee
    style J fill:#e8f5e8
```

# ãŠã¾ã‘ï¼šuseStateã£ã¦ç›´æ„Ÿçš„ã˜ã‚ƒãªããªã„ï¼Ÿ

å€‹äººçš„ã«ã¯ã€ä»¥ä¸‹ã®å®£è¨€ã®ä»•æ–¹ãŒã‚ã‹ã‚Šã«ãã„ãªãã¨æ„Ÿã˜ã¾ã—ãŸã€‚

```typescript
const [count, setCount] = useState(init)
```

ã‚ã‹ã‚Šã«ãã„ãªãã¨æ€ã£ãŸåŸå› ã‚’æ•´ç†ã—ã¦ã¿ãŸã‚‰ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šãã†ã§ã—ãŸã€‚

- æˆ»ã‚Šå€¤ã®ã‚¿ãƒ—ãƒ«ã®1ã¤ç›®ã¨2ã¤ç›®ãŒçŸ¥ã‚‰ãªã„ã¨ä½•ãªã®ã‹ç†è§£ã§ããªã„
- é–¢æ•°åãŒæŠ½è±¡çš„ã§ã€ä½¿ã†ã“ã¨ã—ã‹åˆ†ã‹ã‚‰ãªã„
- useStateã®å¼•æ•°ãŒåˆæœŸå€¤ãªã®ã‚‚çŸ¥ã‚‰ãªã„ã¨åˆ†ã‹ã‚‰ãªã„(å‹ã‚‚`S | () => S`ã§é•ã„ãŒä½•ãªã®ã‹ï¼Ÿã¨ã„ã†ç–‘å•ãŒçŸ¥ã‚‰ãªã„ã¨ç”Ÿã¾ã‚Œã¦ã—ã¾ã†)

ä¾‹ãˆã°ã§ã™ãŒã€ã“ã‚“ãªæ„Ÿã˜ã§å®£è¨€ã§ããŸã‚‰ã„ã„ã®ã«ãªãã¨æ€ã„ã¾ã—ãŸã€‚

```typescript
const countState = State.of(init)
const count = countState.value()
countState.update((c) => c + 1)
```

# ã¾ã¨ã‚

ä»Šå›ã¯`useState`ã«ã¤ã„ã¦ã€å‹å®šç¾©ã‹ã‚‰å†æç”»ã®ä»•çµ„ã¿ã¾ã§èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚
å¼•æ•°ã®å‹ãŒ`S | () => S`å‹ã§ã‚ã‚‹ç†ç”±ã‚„ã€æˆ»ã‚Šå€¤ã‚’ä½¿ã†ã“ã¨ã§`State`ãŒæ›´æ–°ã•ã‚Œã€ãã®å¾Œå†æç”»ã•ã‚Œã‚‹ç†ç”±ãªã©ãŒæ¦‚è¦ãƒ¬ãƒ™ãƒ«ã§ã™ãŒç†è§£ã§ãã¦ã™ã£ãã‚Šã—ã¾ã—ãŸã€‚

ã¾ãŸã€`React`ã£ã¦çµæ§‹ã‚¤ã‚±ã‚¤ã‚±ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã ã£ãŸã®ã§ã™ãŒã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚‚ã‚ã£ã¡ã‚ƒæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã¯ãªãã€ãƒ¡ãƒ³ãƒ†ã‚‚ãªã‹ãªã‹å¤§å¤‰ãã†ã ãªãã¨ã„ã†å°è±¡ã‚’æŒã¡ã¾ã—ãŸã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ğŸ™
